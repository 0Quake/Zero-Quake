<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>Worker For Kmoni Image</title>
</head>

<body>
    <canvas id="kmoniCanvas" width="352" height="400"></canvas>
    <canvas id="SnetCanvas" width="400" height="400"></canvas>
    <canvas id="EstShindoCanvas" width="400" height="400"></canvas>

    <script src="./js/UIcommon.js"></script>
    <script>
        var config;
        var Allpoints;
        var points;
        var Spoints;
        var Svoice
        var Rate;
        var Pitch
        var Volume
        window.electronAPI.messageSend((event, request) => {
            if (request.action == "setting") {
                config = request.data;
                if (!Svoice) {
                    if (config.notice.voice_parameter.voice) {
                        Svoice = speechSynthesis.getVoices().find(function (elm) {
                            return elm.name == config.notice.voice_parameter.voice;
                        });
                    }
                }
                Rate = config.notice.voice_parameter.rate;
                Pitch = config.notice.voice_parameter.pitch;
                Volume = config.notice.voice_parameter.volume
            }
        });


        fetch("./Resource/Knet_Points.json").then(function (res) {
            return res.json()
        }).then(function (json) {
            Allpoints = json
            points = json.filter(function (elm) { return elm.Point && !elm.IsSuspended })

        })
        fetch("./Resource/Snet_Points.json").then(function (res) {
            return res.json()
        }).then(function (json) {
            Spoints = json.filter(function (elm) { return elm.Point && !elm.IsSuspended })
        })

        var canvas = document.getElementById("kmoniCanvas");
        var context = canvas.getContext("2d");
        var Scanvas = document.getElementById("SnetCanvas");
        var Scontext = Scanvas.getContext("2d");
        var EScanvas = document.getElementById("EstShindoCanvas");
        var EScontext = EScanvas.getContext("2d");
        var AudioElms = {
            "EQDetectLv1": new Audio("audio/EQDetectLv1.mp3"),
            "EQDetectLv2": new Audio("audio/EQDetectLv2.mp3"),
            "EEW1": new Audio("audio/EEW1.mp3"),
            "EEW2": new Audio("audio/EEW2.mp3"),
            "EQInfo": new Audio("audio/EQInfo.mp3"),
            "TsunamiInfo": new Audio("audio/TsunamiInfo.mp3")
        }

        window.electronAPI.messageSend((event, request) => {

            if (request.action == "KmoniImgUpdate") {
                var image = new Image();
                image.src = request.data;

                image.onload = function () {
                    context.clearRect(0, 0, canvas.width, canvas.height);
                    context.drawImage(image, 0, 0);
                    kmoniRedraw(request.date)
                };
            } else if (request.action == "SnetImgUpdate") {
                var image = new Image();
                image.src = request.data;

                image.onload = function () {
                    Scontext.clearRect(0, 0, Scanvas.width, Scanvas.height);
                    Scontext.drawImage(image, 0, 0);
                    SnetRedraw(request.date)
                };
            } else if (request.action == "KmoniEstShindoImgUpdate") {
                var EScanvas = document.createElement("canvas");
                EScanvas.width = 472;
                EScanvas.height = 550;
                var ctx = EScanvas.getContext("2d");


                const ESImg = new Image();
                ESImg.src = request.data; // 画像のURLを指定
                ESImg.onload = () => {
                    ctx.drawImage(ESImg, 120, 0);
                    ctx.clearRect(120, 0, 181, 204);
                    ctx.drawImage(ESImg, 0, 0, 181, 204, 0, 335, 181, 204);

                    img = ctx.getImageData(0, 0, EScanvas.width, EScanvas.height)
                    imgData = img.data

                    for (let i = 0; i < imgData.length; i += 4) {
                        r = imgData[i];
                        g = imgData[i + 1];
                        b = imgData[i + 2];
                        if (r + g + b > 0) {
                            nrgb = shindoConvert(0.868589 * Math.log(10 ** (5 * RGBtoP(r, g, b) - 2)) + 1)
                            imgData[i] = nrgb[0]
                            imgData[i + 1] = nrgb[1]
                            imgData[i + 2] = nrgb[2]
                        }

                    }
                    ctx.putImageData(img, 0, 0);

                    b64 = EScanvas.toDataURL("image/png");

                    window.electronAPI.messageReturn({
                        action: "kmoniEstShindoReturn",
                        data: b64,
                        eid: request.eid,
                        serial: request.serial
                    })

                };



            } else if (request.action == "speak") {
                speechSynthesis.cancel()
                // 発言を作成
                const uttr = new SpeechSynthesisUtterance()
                uttr.text = request.data
                uttr.lang = "ja-JP"

                if (!Svoice) {
                    if (config.notice.voice_parameter.voice) {
                        Svoice = speechSynthesis.getVoices().find(function (elm) {
                            return elm.name == config.notice.voice_parameter.voice;
                        });
                    }
                }

                uttr.voice = Svoice;
                uttr.rate = Rate
                uttr.pitch = Pitch;
                uttr.volume = Volume;

                speechSynthesis.speak(uttr)
            } else if (request.action == "soundPlay") {
                var AudioElm = AudioElms[request.data]
                if (AudioElm) {
                    AudioElm.currentTime = 0;
                    if (AudioElm.paused) AudioElm.play()
                }
            }


        })

        function kmoniRedraw(dateTmp) {
            points.forEach(function (elm) {
                elm.data = false

                var rgb = point2RGB(elm.Point.X, elm.Point.Y, context);
                if (rgb[0] + rgb[1] + rgb[2] !== 0) {
                    var p = RGBtoP(rgb[0], rgb[1], rgb[2]);
                    var shindo = (10 * p) - 3;
                    var pga = 10 ** (5 * p - 2);

                    elm.data = true
                    elm.rgb = rgb
                    elm.shindo = shindo
                    elm.pga = pga
                }
            });
            window.electronAPI.messageReturn({
                action: "kmoniReturn",
                data: points,
                date: dateTmp
            })
        }


        function SnetRedraw(dateTmp) {
            Spoints.forEach(function (elm, index) {
                elm.data = false

                var rgb = point2RGB(elm.Point.X, elm.Point.Y, Scontext);
                if (rgb[0] + rgb[1] + rgb[2] !== 0) {
                    var p = RGBtoP(rgb[0], rgb[1], rgb[2]);
                    var shindo = (10 * p - 3);
                    var pga = 10 ** (5 * p - 2);

                    elm.data = true
                    elm.rgb = rgb
                    elm.shindo = shindo
                    elm.pga = pga
                }
            });
            window.electronAPI.messageReturn({
                action: "SnetReturn",
                data: Spoints,
                date: dateTmp
            })

        }

        var oneBeforeData = {}

        function EstShindoRedraw(dateTmp) {
            var estShindos = []
            Allpoints.forEach(function (elm, index) {
                var rgb = point2RGB(elm.Point.X, elm.Point.Y, EScontext);
                if (rgb[0] + rgb[1] + rgb[2] !== 0) {
                    var p = RGBtoP(rgb[0], rgb[1], rgb[2]);
                    var tmpNum = 10 ** (5 * p - 2);
                    var EstShindo = 0.868589 * Math.log(tmpNum) + 1
                    var SectionTmp = estShindos.find(function (elm2) { return elm2.Section == elm.Section })
                    if (SectionTmp) {
                        SectionTmp.estShindo = Math.max(EstShindo, SectionTmp.estShindo)
                    } else {
                        estShindos.push({ Section: elm.Section, estShindo: EstShindo })
                    }
                }
            });
            var nowDataStr = JSON.stringify(estShindos)
            if (estShindos.length !== 0) {
                if (oneBeforeData !== nowDataStr) {
                    window.electronAPI.messageReturn({
                        action: "kmoniEstShindoReturn",
                        data: estShindos,
                        date: dateTmp,
                        nodata: false
                    })
                }
            } else {
                window.electronAPI.messageReturn({
                    action: "kmoniEstShindoReturn",
                    date: dateTmp,
                    data: [],
                    nodata: true
                })
            }
            oneBeforeData = nowDataStr


        }

        function point2RGB(x, y, ctxTmp) {
            var imagedata = ctxTmp.getImageData(x, y, 1, 1);
            return [imagedata.data[0], imagedata.data[1], imagedata.data[2]];
        }

        function RGBtoP(r, g, b) {
            var max = Math.max(r, g, b);
            var min = Math.min(r, g, b);

            var h = 0;
            var s = 0;
            var v = max


            if (max != min) {
                if (max == r) h = 60 * (g - b) / (max - min);
                if (max == g) h = 60 * (b - r) / (max - min) + 120;
                if (max == b) h = 60 * (r - g) / (max - min) + 240;

                s = (max - min) / max;
            }

            if (h < 0) {
                h = h + 360;
            }

            h = h / 360;
            s = s;
            v = v / 255;

            var p = 0;

            if (v > 0.1 && s > 0.75) {
                if (h > 0.1476) {
                    p = 280.31 * Math.pow(h, 6) - 916.05 * Math.pow(h, 5) + 1142.6 * Math.pow(h, 4) - 709.95 * Math.pow(h, 3) + 234.65 * Math.pow(h, 2) - 40.27 * h + 3.2217;
                } else if (h > 0.001) {
                    p = 151.4 * Math.pow(h, 4) - 49.32 * Math.pow(h, 3) + 6.753 * Math.pow(h, 2) - 2.481 * h + 0.9033;
                } else {
                    p = -0.005171 * Math.pow(v, 2) - 0.3282 * v + 1.2236;
                }
            }

            if (p < 0) {
                p = 0;
            }
            return p;
        }

        function shindoConvert(str) {
            if (str < 0.5) {
                return [191, 191, 191]
            } else if (str < 1.5) {
                return [121, 168, 179]
            } else if (str < 2.5) {
                return [54, 133, 224]
            } else if (str < 3.5) {
                return [77, 176, 81]
            } else if (str < 4.5) {
                return [191, 184, 55]
            } else if (str < 5) {
                return [240, 150, 41]
            } else if (str < 5.5) {
                return [245, 113, 61]
            } else if (str < 6) {
                return [230, 0, 0]
            } else if (str < 6.5) {
                return [138, 10, 10]
            } else if (6.5 <= str) {
                return [196, 0, 222]
            } else if (7.5 <= str) {
                return [196, 0, 222]
            } else {
                return [191, 191, 191]
            }
        }
    </script>
</body>

</html>