<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>Worker For Kmoni Image</title>
</head>

<body>
    <canvas id="kmoniCanvas" width="352" height="400"></canvas>
    <canvas id="SnetCanvas" width="400" height="400"></canvas>
    <canvas id="EstShindoCanvas" width="400" height="400"></canvas>

    <script>
        var Allpoints;
        var points;
        var Spoints;
        fetch("./Resource/Knet_Points.json").then(function (res) {
            return res.json()
        }).then(function (json) {
            Allpoints = json
            points = json.filter(function (elm) { return elm.Point && !elm.IsSuspended })

        })
        fetch("./Resource/Snet_Points.json").then(function (res) {
            return res.json()
        }).then(function (json) {
            Spoints = json.filter(function (elm) { return elm.Point && !elm.IsSuspended })
        })

        var canvas = document.getElementById("kmoniCanvas");
        var context = canvas.getContext("2d");
        var Scanvas = document.getElementById("SnetCanvas");
        var Scontext = Scanvas.getContext("2d");
        var EScanvas = document.getElementById("EstShindoCanvas");
        var EScontext = EScanvas.getContext("2d");

        window.electronAPI.messageSend((event, request) => {

            if (request.action == "KmoniImgUpdate") {
                var image = new Image();
                image.src = request.data;

                image.onload = function () {
                    context.clearRect(0, 0, canvas.width, canvas.height);
                    context.drawImage(image, 0, 0);
                    kmoniRedraw(request.date)
                };
            } else if (request.action == "SnetImgUpdate") {
                var image = new Image();
                image.src = request.data;

                image.onload = function () {
                    Scontext.clearRect(0, 0, Scanvas.width, Scanvas.height);
                    Scontext.drawImage(image, 0, 0);
                    SnetRedraw(request.date)
                };
            } else if (request.action == "KmoniEstShindoImgUpdate") {
                var image = new Image();
                image.src = request.data;

                image.onload = function () {
                    EScontext.clearRect(0, 0, EScanvas.width, EScanvas.height);
                    EScontext.drawImage(image, 0, 0);
                    EstShindoRedraw(request.date)
                };

            } else if (request.action == "speak") {
                speechSynthesis.cancel()
                // 発言を作成
                const uttr = new SpeechSynthesisUtterance()
                uttr.text = request.data
                uttr.lang = "ja-JP"
                uttr.rate = 1
                uttr.pitch = 1
                uttr.volume = 1
                speechSynthesis.speak(uttr)
            } else if (request.action == "soundPlay") {
                new Audio(request.data).play()
            }


        })

        function kmoniRedraw(dateTmp) {
            points.forEach(function (elm) {
                elm.data = false

                var rgb = point2RGB(elm.Point.X, elm.Point.Y, context);
                if (rgb[0] + rgb[1] + rgb[2] !== 0) {
                    var hsv = RGB2HSV(rgb[0], rgb[1], rgb[2]);
                    var p = HSVtoP(hsv[0], hsv[1], hsv[2]);
                    var shindo = (10 * p - 3);
                    var pga = 10 ** (5 * p - 2);

                    elm.data = true
                    elm.rgb = rgb
                    elm.shindo = shindo
                    elm.pga = pga
                }
            });
            window.electronAPI.messageReturn({
                action: "kmoniReturn",
                data: points,
                date: dateTmp
            })
        }


        function SnetRedraw(dateTmp) {
            Spoints.forEach(function (elm, index) {
                elm.data = false

                var rgb = point2RGB(elm.Point.X, elm.Point.Y, Scontext);
                if (rgb[0] + rgb[1] + rgb[2] !== 0) {
                    var hsv = RGB2HSV(rgb[0], rgb[1], rgb[2]);
                    var p = HSVtoP(hsv[0], hsv[1], hsv[2]);
                    var shindo = (10 * p - 3);
                    var pga = 10 ** (5 * p - 2);

                    elm.data = true
                    elm.rgb = rgb
                    elm.shindo = shindo
                    elm.pga = pga
                }
            });
            window.electronAPI.messageReturn({
                action: "SnetReturn",
                data: Spoints,
                date: dateTmp
            })

        }

        var oneBeforeData = {}

        function EstShindoRedraw(dateTmp) {
            var estShindos = []
            Allpoints.forEach(function (elm, index) {
                var rgb = point2RGB(elm.Point.X, elm.Point.Y, EScontext);
                if (rgb[0] + rgb[1] + rgb[2] !== 0) {
                    var hsv = RGB2HSV(rgb[0], rgb[1], rgb[2]);
                    var p = HSVtoP(hsv[0], hsv[1], hsv[2]);
                    var tmpNum = 10 ** (5 * p - 2);
                    var EstShindo = 0.868589 * Math.log(tmpNum) + 1
                    var SectionTmp = estShindos.find(function (elm2) { return elm2.Section == elm.Section })
                    if (SectionTmp) {
                        SectionTmp.estShindo = Math.max(EstShindo, SectionTmp.estShindo)
                    } else {
                        estShindos.push({ Section: elm.Section, estShindo: EstShindo })
                    }
                }
            });
            var nowDataStr = JSON.stringify(estShindos)
            if (estShindos.length !== 0) {
                if (oneBeforeData !== nowDataStr) {
                    window.electronAPI.messageReturn({
                        action: "kmoniEstShindoReturn",
                        data: estShindos,
                        date: dateTmp,
                        nodata: false
                    })
                }
            } else {
                window.electronAPI.messageReturn({
                    action: "kmoniEstShindoReturn",
                    date: dateTmp,
                    data: [],
                    nodata: true
                })
            }
            oneBeforeData = nowDataStr


        }

        function point2RGB(x, y, ctxTmp) {
            var imagedata = ctxTmp.getImageData(x, y, 1, 1);
            return [imagedata.data[0], imagedata.data[1], imagedata.data[2]];
        }
        function RGB2HSV(r, g, b) {
            var v = Math.max(r, g, b),
                d = v - Math.min(r, g, b),
                s = v ? d / v : 0,
                a = [r, g, b, r, g],
                i = a.indexOf(v),
                h = s ? (((a[i + 1] - a[i + 2]) / d + i * 2 + 6) % 6) * 60 : 0;
            v /= 255;
            h /= 260;
            return [h, s, v];
        }

        function HSVtoP(h, s, v) {
            var p = 0;

            if (v > 0.1 && s > 0.75) {
                if (h > 0.1476) {
                    p = 280.31 * Math.pow(h, 6) - 916.05 * Math.pow(h, 5) + 1142.6 * Math.pow(h, 4) - 709.95 * Math.pow(h, 3) + 234.65 * Math.pow(h, 2) - 40.27 * h + 3.2217;
                } else if (h > 0.001) {
                    p = 151.4 * Math.pow(h, 4) - 49.32 * Math.pow(h, 3) + 6.753 * Math.pow(h, 2) - 2.481 * h + 0.9033;
                } else {
                    p = -0.005171 * Math.pow(v, 2) - 0.3282 * v + 1.2236;
                }
            }

            if (p < 0) {
                p = 0;
            }
            return p;
        }

    </script>
</body>

</html>