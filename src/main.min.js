const electron=require("electron"),{app:app,BrowserWindow:BrowserWindow,ipcMain:ipcMain,net:net,Notification:Notification,dialog:dialog}=electron,path=require("path"),sound=require("sound-play"),iconv=require("iconv-lite"),Request=require("request"),jsdom=require("jsdom"),{JSDOM:JSDOM}=jsdom;let fs=require("fs");const Store=require("electron-store"),{validateHeaderValue:validateHeaderValue,request:request}=require("http"),store=new Store;var config=store.get("config",{setting1:!0,home:{name:"自宅",latitude:35.68,longitude:139.767,Saibun:"東京都２３区"},KmoniInterval:1e3,LmoniInterval:1e3,YmoniInterval:1e3,notice:{voice:{EEW:"緊急地震速報です。強い揺れに警戒してください。"}}});const userHome=process.env["win32"==process.platform?"USERPROFILE":"HOME"];let mainWindow;var settingWindow,tsunamiWindow;let kmoniWorker;var kmoniActive,kmoniTimeTmp=[];const gotTheLock=app.requestSingleInstanceLock();var kmoniPointsDataTmp;gotTheLock||app.quit(),ipcMain.on("message",(_event,response)=>{if("kmoniReturn"==response.action)kmoniControl(response.data,response.date);else if("tsunamiReqest"==response.action)tsunamiData&&mainWindow.webContents.send("message2",{action:"tsunamiUpdate",data:tsunamiData});else if("EEWReqest"==response.action)EEWNow&&mainWindow.webContents.send("message2",{action:"EEWAlertUpdate",data:EEW_nowList});else if("settingWindowOpen"==response.action)settingWindow||((settingWindow=new BrowserWindow({webPreferences:{preload:path.join(__dirname,"js/preload.js"),title:"設定 - Zero Quake",webSecurity:!1,parent:mainWindow,modal:!0,center:!0,backgroundColor:"#202227",icon:path.join(__dirname,"img/icon.ico")}})).webContents.on("did-finish-load",()=>{settingWindow.webContents.send("message2",{action:"setting",data:{config:config,softVersion:process.env.npm_package_version}})}),settingWindow.on("closed",()=>{settingWindow=null}),settingWindow.setMenuBarVisibility(!1),settingWindow.webContents.openDevTools(),settingWindow.loadFile("src/settings.html"));else if("settingReturn"==response.action)config=response.data,store.set("config",config),settingWindow.webContents.send("message2",{action:"setting",data:{config:config,softVersion:process.env.npm_package_version}});else if("TsunamiWindowOpen"==response.action){if(tsunamiWindow)return void tsunamiWindow.focus();(tsunamiWindow=new BrowserWindow({webPreferences:{preload:path.join(__dirname,"js/preload.js"),title:"Zero Quake",webSecurity:!1,backgroundColor:"#202227",icon:path.join(__dirname,"img/icon.ico")}})).webContents.openDevTools(),tsunamiWindow.webContents.on("did-finish-load",()=>{tsunamiWindow&&tsunamiWindow.webContents.send("message2",{action:"tsunamiUpdate",data:tsunamiData})}),tsunamiWindow.loadFile("src/TsunamiDetail.html"),tsunamiWindow.on("closed",()=>{tsunamiWindow=null})}else if("EQInfoWindowOpen"==response.action){var EQInfoWindow=new BrowserWindow({webPreferences:{preload:path.join(__dirname,"js/preload.js"),title:"地震詳細情報 - Zero Quake",webSecurity:!1,backgroundColor:"#202227",icon:path.join(__dirname,"img/icon.ico")}});EQInfoWindow.webContents.on("did-finish-load",()=>{EQInfoWindow.webContents.send("message2",{action:"setting",data:config}),EQInfoWindow.webContents.send("message2",{action:"metaData",eid:response.eid,urls:response.urls})}),EQInfoWindow.loadFile(response.url)}});var kmoniDataHistory=[],EQDetect_List=[],EQDetectID=0;function kmoniControl(data,date){kmoniActive=!0,kmoniPointsDataTmp={action:"kmoniUpdate",Updatetime:new Date(date),LocalTime:new Date,data:data},mainWindow&&mainWindow.webContents.send("message2",kmoniPointsDataTmp),data.forEach((function(elm,index){elm.pga})),kmoniDataHistory.push(data),(kmoniDataHistory=kmoniDataHistory.slice(10,kmoniDataHistory.length))[9].forEach((function(elm,index){var dataItemHistory=[kmoniDataHistory[0][index].pga,kmoniDataHistory[1][index].pga,kmoniDataHistory[2][index].pga,kmoniDataHistory[3][index].pga,kmoniDataHistory[4][index].pga,kmoniDataHistory[5][index].pga,kmoniDataHistory[6][index].pga,kmoniDataHistory[7][index].pga,kmoniDataHistory[8][index].pga,kmoniDataHistory[9][index].pga],pgaMax,pgaMin,detect=Math.max.apply(null,dataItemHistory)-Math.min.apply(null,dataItemHistory)>1;if(detect)var DetectedEQ=EQDetect_List.find((function(elm2){return geosailing(elm.Location.Latitude,elm.Location.Longitude,elm2.lat,elm2.lng)<=50}));elm.detect=detect}))}function createWindow(){mainWindow?mainWindow.focus():(mainWindow=new BrowserWindow({minWidth:600,minHeight:300,webPreferences:{preload:path.join(__dirname,"js/preload.js"),title:"Zero Quake",webSecurity:!1,backgroundColor:"#202227",icon:path.join(__dirname,"img/icon.ico")}}),mainWindow.webContents.on("did-finish-load",()=>{kmoniTimeTmp.forEach((function(elm){mainWindow.webContents.send("message2",{action:"kmoniTimeUpdate",Updatetime:elm.Updatetime,LocalTime:elm.LocalTime,type:elm.type,condition:"success"})})),mainWindow.webContents.send("message2",{action:"setting",data:config}),EEWNow&&mainWindow.webContents.send("message2",{action:"EEWAlertUpdate",data:EEW_nowList}),mainWindow.webContents.send("message2",{action:"EQInfo",source:"jma",data:eqInfo.jma}),notifications.length>0&&mainWindow.webContents.send("message2",{action:"notification_Update",data:notifications}),P2P_ConnectData&&mainWindow&&mainWindow.webContents.send("message2",{action:"kmoniTimeUpdate",Updatetime:P2P_ConnectData[0],LocalTime:P2P_ConnectData[0],type:"P2P_EEW",condition:P2P_ConnectData[2]}),kmoniPointsDataTmp&&mainWindow.webContents.send("message2",kmoniPointsDataTmp)}),mainWindow.loadFile("src/index.html"),mainWindow.on("closed",()=>{mainWindow=null}),kmonicreateWindow())}function kmonicreateWindow(){kmoniWorker&&kmoniWorker.close(),kmoniWorker=new BrowserWindow({webPreferences:{preload:path.join(__dirname,"js/preload.js")},backgroundThrottling:!1,show:!1}),kmoniWorker.loadFile("src/kmoniWorker.html")}app.whenReady().then(()=>{createWindow(),kmonicreateWindow(),points=JSON.parse(fs.readFileSync(path.join(__dirname,"Resource/Knet_Points.json"),"utf8")),async function(){await yoyuSetY(),await kmoniServerSelect(),await start()}(),app.on("activate",()=>{0===BrowserWindow.getAllWindows().length&&createWindow()})}),app.on("window-all-closed",()=>{});let tray=null;electron.app.on("ready",()=>{"darwin"===process.platform&&electron.app.dock.hide(),tray=new electron.Tray(`${__dirname}/img/icon.${"win32"===process.platform?"ico":"png"}`),tray.setContextMenu(electron.Menu.buildFromTemplate([{label:"画面の表示",click:()=>{createWindow()}},{type:"separator"},{label:"終了",role:"quit"}])),tray.on("double-click",(function(){createWindow()}))});var EEW_Data=[],EEW_nowList=[],EEW_history=[],Yoyu=100,yoyuY=0,yoyuK=0,yoyuL=0,yoyuYOK=!1,Replay=0,EEWNow=!1,errorCount=0;function kmoniRequest(){if(net.online){var request=net.request("http://www.kmoni.bosai.go.jp/webservice/hypo/eew/"+dateEncode(1,new Date-yoyuK-Replay)+".json");request.on("response",res=>{var dataTmp="";300<=res._responseHead.statusCode||res._responseHead.statusCode<200?(yoyuY+=100,++errorCount>3&&kmoniServerSelect()):errorCount=0,res.on("data",chunk=>{dataTmp+=chunk}),res.on("end",(function(){var json;EEWdetect(2,jsonParse(dataTmp),1)}))}),request.on("error",error=>{NetworkError(error,"強震モニタ"),kmoniTimeUpdate(new Date,"kmoni","Error")}),request.end()}if(net.online){var ReqTime=new Date-yoyuK;Request({method:"GET",url:"http://www.kmoni.bosai.go.jp/data/map_img/RealTimeImg/acmap_s/"+dateEncode(2,ReqTime)+"/"+dateEncode(1,ReqTime)+".acmap_s.gif",encoding:null},(error,response,body)=>{if(null!==error)return NetworkError(error,"強震モニタ"),!1;kmoniWorker&&kmoniWorker.webContents.send("message2",{action:"KmoniImgUpdate",data:"data:image/gif;base64,"+body.toString("base64"),date:ReqTime})})}}function lmoniRequest(){if(net.online){var request=net.request("https://www.lmoni.bosai.go.jp/monitor/webservice/hypo/eew/"+dateEncode(1,new Date-yoyuL-Replay)+".json");request.on("response",res=>{var dataTmp="";300<=res._responseHead.statusCode||res._responseHead.statusCode<200?(yoyuY+=100,++errorCount>3&&kmoniServerSelect()):errorCount=0,res.on("data",chunk=>{dataTmp+=chunk}),res.on("end",(function(){var json;EEWdetect(2,jsonParse(dataTmp),2)}))}),request.on("error",error=>{NetworkError(error,"長周期地震動モニタ"),kmoniTimeUpdate(new Date,"Lmoni","Error")}),request.end()}}function ymoniRequest(){var request;if(net.online)if("YE"==monitorVendor)(request=net.request("https://weather-kyoshin.east.edge.storage-yahoo.jp/RealTimeData/"+dateEncode(2,new Date-yoyuY-Replay)+"/"+dateEncode(1,new Date-yoyuY-Replay)+".json")).on("response",res=>{var dataTmp="";300<=res._responseHead.statusCode||res._responseHead.statusCode<200?(yoyuY+=100,++errorCount>3&&kmoniServerSelect()):errorCount=0,res.on("data",chunk=>{dataTmp+=chunk}),res.on("end",(function(){var json;EEWdetect(1,jsonParse(dataTmp))}))}),request.on("error",error=>{NetworkError(error,"Yahoo強震モニタ(East)"),kmoniTimeUpdate(new Date,"YahooKmoni","Error","East")}),request.end();else if("YW"==monitorVendor){var request;(request=net.request("https://weather-kyoshin.west.edge.storage-yahoo.jp/RealTimeData/"+dateEncode(2,new Date-yoyuY-Replay)+"/"+dateEncode(1,new Date-yoyuY-Replay)+".json")).on("response",res=>{var dataTmp="";300<=res._responseHead.statusCode||res._responseHead.statusCode<200?(yoyuY+=100,++errorCount>3&&kmoniServerSelect()):errorCount=0,res.on("data",chunk=>{dataTmp+=chunk}),res.on("end",(function(){var json;EEWdetect(1,jsonParse(dataTmp))}))}),request.on("error",error=>{NetworkError(error,"Yahoo強震モニタ(West)"),kmoniTimeUpdate(new Date,"YahooKmoni","Error","West")}),request.end()}}function P2P_WS(){var WebSocketClient,client=new(0,require("websocket").client);client.on("connectFailed",(function(error){kmoniTimeUpdate(new Date,"P2P_EEW","Error")})),client.on("connect",(function(connection){connection.on("error",(function(error){kmoniTimeUpdate(new Date,"P2P_EEW","Error")})),connection.on("close",(function(){kmoniTimeUpdate(new Date,"P2P_EEW","Disconnect"),P2P_WS()})),connection.on("message",(function(message){if("utf8"===message.type){var data=message.utf8Data;switch(data.code){case 551:break;case 552:data.canceled&&(data.forEach((function(elm){elm.canceled=!0})),data.revocation=!1,data.source="P2P"),TsunamiInfoControl(data);break;case 554:break;case 556:EEWdetect(3,data)}data.time&&kmoniTimeUpdate(new Date(data.time),"P2P_EEW","success")}})),kmoniTimeUpdate(new Date,"P2P_EEW","success")})),client.connect("wss://api.p2pquake.net/v2/ws")}function start(){ymoniRequest(),kmoniRequest(),lmoniRequest(),P2P_WS(),yoyuSetK((function(){setInterval(kmoniRequest,1e3)})),yoyuSetL((function(){setInterval(lmoniRequest,1e3)})),setInterval(ymoniRequest,1e3),setInterval((function(){kmoniActive||kmonicreateWindow()}),1e4),setInterval((function(){EEW_nowList.forEach((function(elm){new Date-Replay-new Date(dateEncode(3,Number(elm.origin_time),1))>3e5&&EEWClear(null,elm.report_id,null,!0)}))}),1e3),setInterval(eqInfoUpdate,1e4),eqInfoUpdate(),SNXWatch()}function SNXWatch(){for(let i=1;i<=10;i++){filenameTmp="SignalNowX_"+String(i).padStart(2,"0")+".csl";var pathTmp=path.join(userHome,"/AppData/Roaming/StrategyCorporation/SignalNowX/"+filenameTmp);fs.existsSync(pathTmp)&&fs.watch(pathTmp,(function(eventType,filename){SNXLogRead(filename)})),SNXLogRead(filenameTmp)}}var intColorConv={"0xFFFFFFFF":"0","0xFFF2F2FF":"1","0xFF00AAFF":"2","0xFF0041FF":"3","0xFFFAE696":"4","0xFFFFE600":"5-","0xFFFF9900":"5+","0xFFFF2800":"6-","0xFFA50021":"6+","0xFFB40068":"7"},tsunamiData,lwaveTmp;function SNXLogRead(str){var pathTmp=path.join(userHome,"/AppData/Roaming/StrategyCorporation/SignalNowX/"+str);fs.existsSync(pathTmp)&&fs.readFile(pathTmp,(function(err,content){var buffer;err&&console.error(err);let logData=Buffer.from(content).toString();var SNXDataTmp=[];let dataTmp,dataTmp2;var eidTmp;logData.split("MsgType=9").forEach((function(elm){var eidTmp,reportnumTmp,origintimeTmp,reporttimeTmp,arrivaltimeTmp,intTmp;elm.split("<BOM>").forEach((function(elm2){-1!=elm2.indexOf("対象EQ ID")?(eidTmp=elm2.split(" = ")[1].substring(2,16),reportnumTmp=elm2.split(" = ")[1].substring(17,20)):-1!=elm2.indexOf("地震発生時刻(a)")?origintimeTmp=elm2.split(" = ")[1].substring(0,19):-1!=elm2.indexOf("地震到達予測時刻(c)")?arrivaltimeTmp=elm2.split(" = ")[1].substring(0,19):-1!=elm2.indexOf("現在時刻(d)")?reporttimeTmp=elm2.split(" = ")[1].substring(0,19):-1!=elm2.indexOf("震度階級色")&&(intTmp=intColorConv[elm2.split(" = ")[1].substring(0,10)])})),origintimeTmp&&(eidTmp||reportnumTmp||intTmp)&&SNXDataTmp.push({alertflg:null,report_id:eidTmp,report_num:Number(reportnumTmp),report_time:new Date(reporttimeTmp),condition:null,magunitude:null,calcintensity:null,depth:null,is_cancel:null,is_final:null,is_training:null,latitude:null,longitude:null,region_code:null,region_name:null,origin_time:new Date(origintimeTmp),isPlum:null,userIntensity:intTmp,arrivalTime:new Date(arrivaltimeTmp),intensityAreas:null,warnZones:{zone:null,Pref:null,Regions:null},source:"SignalNow X"})})),logData.split("<BOM>").forEach((function(elm){if(-1!=elm.indexOf("[OnEq01Queued]() Objective EqId ="))eidTmp=elm.split("[OnEq01Queued]() Objective EqId = ")[1].split('"')[0].replace("ND","");else if(eidTmp&&-1!=elm.indexOf("[CalculateEqEffect()]()")){var item=elm.split("[CalculateEqEffect()]()")[1].split("|")[0].split(",");if(11==item.length){var latTmp=Number(item[0].split(": ")[1]),lngTmp=Number(item[1].split(": ")[1]),depthTmp=Number(item[2].split(": ")[1]),magTmp=Number(item[3].split(": ")[1]),SNXDataItem=SNXDataTmp.find((function(elm){return elm.report_id==eidTmp}));SNXDataItem&&(SNXDataItem.magunitude=magTmp,SNXDataItem.latitude=latTmp,SNXDataItem.longitude=lngTmp,SNXDataItem.depth=depthTmp)}}})),SNXDataTmp.forEach((function(elm){EEWcontrol(elm)}))}))}function EEWdetect(type,json,KorL){if(json)if(1==type){const request_time=new Date(json.realTimeData.dataTime);kmoniTimeUpdate(request_time,"YahooKmoni","success",monitorVendor),json.hypoInfo&&json.hypoInfo.items.forEach((function(elm){var EEWdata;EEWcontrol({alertflg:null,report_id:elm.reportId,report_num:Number(elm.reportNum),report_time:new Date(json.realTimeData.dataTime),magunitude:Number(elm.magnitude),calcintensity:shindoConvert(elm.calcintensity,0),depth:Number(elm.depth.replace("km","")),is_cancel:Boolean2(elm.isCancel),is_final:Boolean2(elm.isFinal),is_training:Boolean2(elm.isTraining),latitude:latitudeConvert(elm.latitude),longitude:latitudeConvert(elm.longitude),region_code:elm.regionCode,region_name:elm.regionName,origin_time:new Date(elm.originTime),isPlum:!1,userIntensity:null,arrivalTime:null,intensityAreas:null,warnZones:{zone:null,Pref:null,Regions:null},source:"YahooKmoni"})}))}else if(2==type){const year=parseInt(json.request_time.substring(0,4)),month=parseInt(json.request_time.substring(4,6)),day=parseInt(json.request_time.substring(6,8)),hour=parseInt(json.request_time.substring(8,10)),min=parseInt(json.request_time.substring(10,12)),sec=parseInt(json.request_time.substring(12,15)),request_time=new Date(year,month-1,day,hour,min,sec);var sourceTmp;if(1==KorL?sourceTmp="kmoni":2==KorL&&(sourceTmp="Lmoni"),kmoniTimeUpdate(request_time,sourceTmp,"success"),""==json.result.message){var origin_timeTmp=new Date(json.origin_time.slice(0,4),json.origin_time.slice(4,6)-1,json.origin_time.slice(6,8),json.origin_time.slice(8,10),json.origin_time.slice(10,12),json.origin_time.slice(12,14)),EEWdata;EEWcontrol(EEWdata={alertflg:json.alertflg,report_id:json.report_id,report_num:Number(json.report_num),report_time:new Date(json.report_time),magunitude:Number(json.magunitude),calcintensity:shindoConvert(json.calcintensity,0),depth:Number(json.depth.replace("km","")),is_cancel:Boolean2(json.is_cancel),is_final:Boolean2(json.is_final),is_training:Boolean2(json.is_training),latitude:Number(json.latitude),longitude:Number(json.longitude),region_code:json.region_code,region_name:json.region_name,origin_time:origin_timeTmp,isPlum:!1,userIntensity:null,arrivalTime:null,intensityAreas:null,warnZones:{zone:null,Pref:null,Regions:null},source:sourceTmp})}json.avrarea?(EEWdata=Object.assign(EEWdata,{avrarea:json.avrarea,avrarea_list:json.avrarea_list,avrval:json.avrval,avrrank:json.avrrank}),mainWindow&&mainWindow.webContents.send("message2",{action:"longWaveUpdate",data:{avrarea:json.avrarea,avrarea_list:json.avrarea_list,avrval:json.avrval,avrrank:json.avrrank}})):2==KorL&&lwaveTmp&&mainWindow&&mainWindow.webContents.send("message2",{action:"longWaveClear"}),2==KorL&&(lwaveTmp=json.avrarea)}else if(3==type){const reception_time=new Date(json.time);var maxIntTmp=Math.floor(Math.max.apply(null,json.areas.map((function(p){return p.scaleTo})))),latitudeTmp,longitudeTmp,depthTmp,magnitudeTmp,region_nameTmp,origin_timeTmp;json.earthquake&&(200!==latitudeTmp&&(latitudeTmp=json.earthquake.hypocenter.latitude),200!==longitudeTmp&&(longitudeTmp=json.earthquake.hypocenter.longitude),-1!==depthTmp&&(depthTmp=json.earthquake.hypocenter.depth),-1!==magnitudeTmp&&(magnitudeTmp=json.earthquake.hypocenter.magnitude),region_nameTmp=json.earthquake.hypocenter.name,origin_timeTmp=new Date(json.earthquake.originTime));var EEWdata={alertflg:"警報",report_id:json.issue.eventId,report_num:Number(json.issue.serial),report_time:new Date(json.issue.time),magunitude:magnitudeTmp,calcintensity:shindoConvert(maxIntTmp),depth:depthTmp,is_cancel:Boolean(json.canceled),is_final:null,is_training:Boolean(json.test),latitude:latitudeTmp,longitude:longitudeTmp,region_code:"",region_name:region_nameTmp,origin_time:origin_timeTmp,isPlum:"仮定震源要素"==conditionTmp,userIntensity:null,arrivalTime:null,intensityAreas:null,warnZones:{zone:null,Pref:null,Regions:null},source:"P2P_EEW"};kmoniTimeUpdate(new Date(json.issue.time),"P2P_EEW","success");var areaTmp=[];json.areas.forEach((function(elm){areaTmp.push({pref:elm.pref,name:elm.name,scaleFrom:shindoConvert(lm.scaleFrom),scaleTo:shindoConvert(elm.scaleTo),kindCode:elm.kindCode,arrivalTime:new Date(elm.arrivalTime)})})),EEWdata.intensityAreas=areaTmp,EEWcontrol(EEWdata)}}function EEWcontrol(data){var pastTime=new Date-Replay-data.origin_time,EQJSON;if(!(pastTime>3e5||pastTime<0))if(EEW_history[data.source]||(EEW_history[data.source]=[]),EEW_history[data.source].find((function(elm){return data.report_id==elm.report_id&&data.report_num==elm.report_num}))||EEW_history[data.source].push(data),data.latitude&&data.longitude&&(data.distance=geosailing(data.latitude,data.longitude,config.home.latitude,config.home.longitude)),EQJSON=EEW_Data.find((function(elm){return elm.EQ_id==data.report_id}))){var EEWJSON=EQJSON.data.find((function(elm2){return elm2.report_num==data.report_num})),saishin=data.report_num>Math.max.apply(null,EQJSON.data.map((function(o){return o.report_num}))),oneBefore=data.report_num==Math.max.apply(null,EQJSON.data.map((function(o){return o.report_num})));if(!EEWJSON&&saishin){var EQJSON=EEW_Data.find((function(elm){return elm.EQ_id==data.report_id}));if(!data.arrivalTime){var oneBeforeData=EQJSON.data.filter((function(elm){return elm.arrivalTime})),newEstID=Math.max.apply(null,oneBeforeData.map((function(o){return o.report_num})));(oneBeforeData=oneBeforeData.find((function(elm){return elm.report_num==newEstID})))&&(data.arrivalTime=oneBeforeData.arrivalTime)}EEWAlert(data,!1),EQJSON.data.push(data),data.is_cancel&&(EQJSON.canceled=!0)}else if(EEWJSON&&oneBefore){var changed=!1;!(oneBeforeData=EQJSON.data.find((function(elm){return elm.report_num==data.report_num}))).alertflg&&data.alertflg&&(oneBeforeData.alertflg=data.alertflg,changed=!0),!oneBeforeData.magunitude&&data.magunitude&&(oneBeforeData.magunitude=data.magunitude,changed=!0),!oneBeforeData.calcintensity&&data.calcintensity&&(oneBeforeData.calcintensity=data.calcintensity,changed=!0),!oneBeforeData.depth&&data.depth&&(oneBeforeData.depth=data.depth,changed=!0),!oneBeforeData.is_cancel&&data.is_cancel&&(oneBeforeData.is_cancel=data.is_cancel,changed=!0),!oneBeforeData.is_final&&data.is_final&&(oneBeforeData.is_final=data.is_final,changed=!0),!oneBeforeData.is_training&&data.is_training&&(oneBeforeData.is_training=data.is_training,changed=!0),!oneBeforeData.latitude&&data.latitude&&(oneBeforeData.latitude=data.latitude,changed=!0),!oneBeforeData.longitude&&data.longitude&&(oneBeforeData.longitude=data.longitude,changed=!0),!oneBeforeData.region_code&&data.region_code&&(oneBeforeData.region_code=data.region_code,changed=!0),!oneBeforeData.region_name&&data.region_name&&(oneBeforeData.region_name=data.region_name,changed=!0),!oneBeforeData.origin_time&&data.origin_time&&(oneBeforeData.origin_time=data.origin_time,changed=!0),!oneBeforeData.isPlum&&data.isPlum&&(oneBeforeData.isPlum=data.isPlum,changed=!0),!oneBeforeData.intensityAreas&&data.intensityAreas&&(oneBeforeData.intensityAreas=data.intensityAreas,changed=!0),!oneBeforeData.warnZone&&data.warnZone&&(oneBeforeData.warnZone=data.warnZone,changed=!0),!oneBeforeData.userIntensity&&data.userIntensity&&(oneBeforeData.userIntensity=data.userIntensity,changed=!0),data.arrivalTime&&!oneBeforeData.arrivalTime&&(oneBeforeData.arrivalTime=data.arrivalTime,changed=!0),changed&&EEWAlert(oneBeforeData,!1,!0)}}else EEWAlert(data,!0),EEW_Data.push({EQ_id:data.report_id,canceled:!1,data:[data]})}function EEWAlert(data,first,update){if(EEWNow=!0,(EEW_nowList=EEW_nowList.filter((function(elm){return elm.report_id!==data.report_id}))).push(data),mainWindow)mainWindow.webContents.send("message2",{action:"EEWAlertUpdate",data:EEW_nowList,update:Boolean(update)});else if(!update){var EEWNotification=new Notification({title:"緊急地震速報（"+data.alertflg+"）#"+data.report_num,body:data.region_name+"\n推定震度："+data.calcintensity+"  M"+data.magunitude+"  深さ："+data.depth});EEWNotification.show(),EEWNotification.on("click",(function(){createWindow()}))}update||(kmoniWorker&&kmoniWorker.webContents.send("message2",{action:"speak",data:"緊急地震速報です。"}),first&&("警報"==data.alertflg?sound.play(path.join(__dirname,"audio/EEW1.mp3")):"予報"==data.alertflg&&sound.play(path.join(__dirname,"audio/EEW2.mp3")),createWindow()))}function EEWClear(source,code,reportnum,bypass){if(EEWNow||bypass){if(!bypass&&EEW_history[source])var EEW_detected=EEW_history[source].find((function(elm){return code==elm.report_id}));(EEW_detected||bypass)&&(EEW_nowList=EEW_nowList.filter((function(elm){return elm.report_id!==code})),mainWindow&&mainWindow.webContents.send("message2",{action:"EEWAlertUpdate",data:EEW_nowList}),0==EEW_nowList.length&&(EEWNow=!1))}}var eqInfo={jma:[],usgs:[]},aaa=0;function eqInfoUpdate(){var request,request,request,request;(request=net.request("https://www.jma.go.jp/bosai/quake/data/list.json")).on("response",res=>{var dataTmp="";res.on("data",chunk=>{dataTmp+=chunk}),res.on("end",(function(){var json=jsonParse(dataTmp),dataTmp2=[];json=json.filter((function(elm){return"震度速報"==elm.ttl||"震源に関する情報"==elm.ttl||"震源・震度情報"==elm.ttl||"遠地地震に関する情報"==elm.ttl||"顕著な地震の震源要素更新のお知らせ"==elm.ttl}));for(let i=0;i<10;i++){var elm=json[i],maxi=elm.maxi;maxi||(maxi=shindoConvert("?",1)),dataTmp2.push({eventId:elm.eid,category:elm.ttl,OriginTime:new Date(elm.at),epiCenter:elm.anm,M:elm.mag,maxI:maxi,cancel:"取消"==elm.ift,reportDateTime:new Date(elm.rdt),DetailURL:[String("https://www.jma.go.jp/bosai/quake/data/"+elm.json)]})}eqInfoControl(dataTmp2,"jma")}))}),request.on("error",error=>{NetworkError(error,"気象庁ホームページ")}),request.end(),(request=net.request("https://www.data.jma.go.jp/developer/xml/feed/eqvol.xml")).on("response",res=>{var dataTmp="";res.on("data",chunk=>{dataTmp+=chunk}),res.on("end",(function(){const parser=new((new JSDOM).window.DOMParser),xml=parser.parseFromString(dataTmp,"text/html");xml.querySelectorAll("entry").forEach((function(elm){var title=elm.querySelector("title").textContent,url=elm.querySelector("id").textContent;url&&("震度速報"==title||"震源に関する情報"==title||"震源・震度情報"==title||"遠地地震に関する情報"==title||"顕著な地震の震源要素更新のお知らせ"==title?JMAEQInfoFetch(url):/大津波警報|津波警報|津波注意報|津波予報/.test(title))}))}))}),request.on("error",error=>{NetworkError(error,"気象庁防災情報XML")}),request.end(),(request=net.request("https://www3.nhk.or.jp/sokuho/jishin/data/JishinReport.xml")).on("response",res=>{var dataTmp="";res.on("data",chunk=>{dataTmp+=iconv.decode(chunk,"shift_jis").toString()}),res.on("end",(function(){const parser=new((new JSDOM).window.DOMParser),xml=parser.parseFromString(dataTmp,"text/html");var items=xml.getElementsByTagName("item"),urls=[];for(let i=0;i<10;i++){var url=items[i].getAttribute("url");urls.push(url);var request=net.request({url:url,encoding:null});request.on("response",res=>{var dataTmp2="";res.on("data",chunk=>{dataTmp2+=iconv.decode(chunk,"shift_jis").toString()}),res.on("end",(function(){const parser2=new((new JSDOM).window.DOMParser),xml2=parser.parseFromString(dataTmp2,"text/html");var eid="20"+urls[i].split("data/")[1].split("_")[0].slice(-12),OriginTime,epiCenter,magnitude,maxI,OriginTime;xml2.querySelector("Earthquake")&&(OriginTime=new Date(xml2.querySelector("Earthquake").getAttribute("Time")),epiCenter=xml2.querySelector("Earthquake").getAttribute("Epicenter"),magnitude=xml2.querySelector("Earthquake").getAttribute("Magnitude"),maxI=xml2.querySelector("Earthquake").getAttribute("Intensity")),xml2.querySelector("OriginTime")&&(OriginTime=new Date(xml2.querySelector("OriginTime").textContent)),eqInfoControl([{eventId:eid,category:"?",OriginTime:OriginTime,epiCenter:epiCenter,M:magnitude,maxI:maxI,reportDateTime:OriginTime,DetailURL:[urls[i]]}],"jma")}))}),request.end()}}))}),request.on("error",error=>{NetworkError(error,"NHKホームページ")}),request.end(),EQI_narikakunList_Req("https://ntool.online/api/earthquakeList?year="+(new Date).getFullYear()+"&month="+((new Date).getMonth()+1),10,!0),(request=net.request("https://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson&limit=10")).on("response",res=>{var dataTmp="";res.on("data",chunk=>{dataTmp+=chunk}),res.on("end",(function(){var json=jsonParse(dataTmp),dataTmp2=[];json.features.forEach((function(elm){dataTmp2.push({eventId:elm.id,category:null,OriginTime:new Date(elm.properties.time),epiCenter:elm.properties.place,M:elm.properties.mag,maxI:null,DetailURL:[elm.properties.url]})})),eqInfoControl(dataTmp2,"usgs")}))}),request.on("error",error=>{NetworkError(error,"USGS")}),request.end()}var narikakun_URLs=[];function EQI_narikakunList_Req(url,num,first){var request=net.request(url);request.on("response",res=>{var dataTmp="";res.on("data",chunk=>{dataTmp+=chunk}),res.on("end",(function(){var json=jsonParse(dataTmp);if((narikakun_URLs=narikakun_URLs.concat(json.lists)).length<num&&first){var yearTmp=(new Date).getFullYear(),monthTmp=(new Date).getMonth();0==monthTmp&&(yearTmp=(new Date).getFullYear()-1,monthTmp=1),EQI_narikakun_Req("ntool.online/api/earthquakeList?year="+yearTmp+"&month="+monthTmp,num-json.lists.length,!1)}else narikakun_URLs.slice(0,10).forEach((function(elm){EQI_narikakun_Req(elm)})),narikakun_URLs=[]}))}),request.on("error",error=>{NetworkError(error,"narikakun 地震情報API")}),request.end()}function EQI_narikakun_Req(url){var request=net.request(url);request.on("response",res=>{var dataTmp="";res.on("data",chunk=>{dataTmp+=chunk}),res.on("end",(function(){var json=jsonParse(dataTmp),originTimeTmp=json.Body.Earthquake?new Date(json.Body.Earthquake.OriginTime):null,epiCenterTmp=json.Body.Earthquake?json.Body.Earthquake.Hypocenter.Name:null,MagnitudeTmp=json.Body.Earthquake?json.Body.Earthquake.Magnitude:null,MaxITmp=json.Body.Intensity?json.Body.Intensity.Observation.MaxInt:null,cancel="取消"==json.Head.InfoType,dataTmp2;eqInfoControl([{eventId:json.Head.EventID,category:json.Head.Title,OriginTime:originTimeTmp,epiCenter:epiCenterTmp,M:MagnitudeTmp,maxI:MaxITmp,cancel:cancel,reportDateTime:new Date(json.Head.ReportDateTime),DetailURL:[url]}],"jma")}))}),request.on("error",error=>{NetworkError(error,"narikakun 地震情報API")}),request.end()}function JMAEQInfoFetch(url){if(url){var request=net.request(url);request.on("response",res=>{var dataTmp="";res.on("data",chunk=>{dataTmp+=chunk}),res.on("end",(function(){0==aaa&&(dataTmp='<Report xmlns="http://xml.kishou.go.jp/jmaxml1/" xmlns:jmx="http://xml.kishou.go.jp/jmaxml1/"><Control><Title>顕著な地震の震源要素更新のお知らせ</Title><DateTime>2022-11-09T10:40:13Z</DateTime><Status>通常</Status><EditorialOffice>気象庁本庁</EditorialOffice><PublishingOffice>気象庁</PublishingOffice></Control><Head xmlns="http://xml.kishou.go.jp/jmaxml1/informationBasis1/"><Title>顕著な地震の震源要素更新のお知らせ</Title><ReportDateTime>2022-11-09T19:40:00+09:00</ReportDateTime><TargetDateTime>2022-11-09T19:40:00+09:00</TargetDateTime><EventID>20221109174020</EventID><InfoType>発表</InfoType><Serial/><InfoKind>震源要素更新のお知らせ</InfoKind><InfoKindVersion>1.0_0</InfoKindVersion><Headline><Text>令和　４年１１月　９日１９時４０分をもって、地震の発生場所と規模を更新します。</Text></Headline></Head><Body xmlns="http://xml.kishou.go.jp/jmaxml1/body/seismology1/" xmlns:jmx_eb="http://xml.kishou.go.jp/jmaxml1/elementBasis1/"><Earthquake><OriginTime>2022-11-09T17:40:00+09:00</OriginTime><ArrivalTime>2022-11-09T17:40:00+09:00</ArrivalTime><Hypocenter><Area><Name>茨城県南部</Name><Code type="震央地名">301</Code><jmx_eb:Coordinate description="北緯３６．２度　東経１４０．０度　深さ　５０ｋｍ" datum="日本測地系">+36.2+140.0-50000/</jmx_eb:Coordinate><jmx_eb:Coordinate type="震源位置（度分）" description="北緯３６度１１．１分　東経１４０度０１．６分　深さ　５１ｋｍ">+3611.1+14001.6-51000/</jmx_eb:Coordinate></Area></Hypocenter><jmx_eb:Magnitude type="Mj" description="Ｍ４．９">4.9</jmx_eb:Magnitude></Earthquake><Comments><FreeFormComment>度単位の震源要素は、津波情報等を引き続き発表する場合に使用されます。</FreeFormComment></Comments></Body></Report>'),aaa++;const parser=new((new JSDOM).window.DOMParser),xml=parser.parseFromString(dataTmp,"text/html");var title=xml.title,cancel="取り消し"==xml.querySelector("InfoType").textContent;if("震度速報"==title||"震源に関する情報"==title||"震源・震度情報"==title||"遠地地震に関する情報"==title||"顕著な地震の震源要素更新のお知らせ"==title){var EarthquakeElm=xml.querySelector("Body Earthquake"),originTimeTmp,epiCenterTmp,magnitudeTmp;EarthquakeElm&&(originTimeTmp=new Date(EarthquakeElm.querySelector("OriginTime").textContent),epiCenterTmp=EarthquakeElm.querySelector("Name").textContent,magnitudeTmp=Number(EarthquakeElm.getElementsByTagName("jmx_eb:Magnitude").textContent));var IntensityElm=xml.querySelector("Body Intensity"),maxIntTmp;IntensityElm&&(maxIntTmp=shindoConvert(IntensityElm.querySelector("MaxInt"))),eqInfoControl([{eventId:xml.querySelector("EventID").textContent,category:xml.title,OriginTime:originTimeTmp,epiCenter:epiCenterTmp,M:magnitudeTmp,maxI:maxIntTmp,cancel:cancel,reportDateTime:new Date(xml.querySelector("ReportDateTime").textContent),DetailURL:[url]}],"jma")}else if(/大津波警報|津波警報|津波注意報|津波予報/.test(title))if(cancel){var tsunamiDataTmp;TsunamiInfoControl(tsunamiDataTmp={issue:{time:new Date(xml.querySelector("ReportDateTime").textContent)},areas:[],revocation:!0})}else{var tsunamiDataTmp={issue:{time:new Date(xml.querySelector("ReportDateTime").textContent)},areas:[],revocation:!1,source:"jmaXML"};xml.querySelector("Body Tsunami")&&xml.querySelectorAll("Body Tsunami Forecast Item").forEach((function(elm){var gradeTmp,canceledTmp=!1,firstHeightTmp,firstHeightConditionTmp,maxHeightTmp;switch(Number(elm.querySelector("Category Kind Code").textContent)){case 52:case 53:gradeTmp="MajorWarning";break;case 51:gradeTmp="Warning";break;case 62:gradeTmp="Watch";break;case 71:case 72:case 73:gradeTmp="Yoho";break;case 50:case 60:canceledTmp=!0}elm.querySelector("FirstHeight")&&(elm.querySelector("FirstHeight ArrivalTime")&&(firstHeightTmp=new Date(elm.querySelector("FirstHeight ArrivalTime").textContent)),elm.querySelector("FirstHeight Condition")&&(firstHeightConditionTmp=elm.querySelector("FirstHeight Condition").textContent),elm.querySelector("MaxHeight").getElementsByTagName("jmx_eb:TsunamiHeight")&&(maxHeightTmp=(maxHeightTmp=elm.querySelector("MaxHeight").getElementsByTagName("jmx_eb:TsunamiHeight")[0].getAttribute("description")).replace(/[Ａ-Ｚａ-ｚ０-９．]/g,(function(s){return String.fromCharCode(s.charCodeAt(0)-65248)})))),tsunamiDataTmp.areas.push({code:Number(elm.querySelector("Category Kind Code").textContent),grade:gradeTmp,name:elm.querySelector("Name").textContent,canceled:canceledTmp,firstHeight:firstHeightTmp,firstHeightCondition:firstHeightConditionTmp,maxHeight:maxHeightTmp})})),TsunamiInfoControl(tsunamiDataTmp)}}))}),request.on("error",error=>{NetworkError(error,"気象庁防災情報XML")}),request.end()}}function eqInfoControl(dataList,type){switch(type){case"jma":var eqInfoTmp=[];dataList.forEach((function(data,index){var EQElm=eqInfo.jma.concat(eqInfoTmp).find((function(elm){return elm.eventId==data.eventId}));EQElm?(data.OriginTime&&(!EQElm.OriginTime||EQElm.reportDateTime<data.reportDateTime)&&(EQElm.OriginTime=data.OriginTime),data.epiCenter&&(!EQElm.epiCenter||EQElm.reportDateTime<data.reportDateTime)&&(EQElm.epiCenter=data.epiCenter),data.M&&(!EQElm.M||EQElm.reportDateTime<data.reportDateTime)&&(EQElm.M=data.M),data.maxI&&(!EQElm.maxI||EQElm.reportDateTime<data.reportDateTime)&&(EQElm.maxI=data.maxI),data.cancel&&(!EQElm.cancel||EQElm.reportDateTime<data.reportDateTime)&&(EQElm.cancel=data.cancel),data.DetailURL&&""!==data.DetailURL[0]&&!EQElm.DetailURL.includes(data.DetailURL[0])&&EQElm.DetailURL.push(data.DetailURL[0]),eqInfoAlert(EQElm,"jma",!0)):eqInfoTmp.push(data),index==dataList.length-1&&eqInfoAlert(eqInfoTmp,"jma")}));break;case"usgs":dataList.forEach((function(elm){eqInfoAlert(elm,"usgs")}))}}function eqInfoAlert(data,source,update){if("jma"==source){if(update){var EQInfoTmp=eqInfo.jma.find((function(elm){return elm.eventId==data.eventId}));EQInfoTmp=data}else eqInfo.jma=eqInfo.jma.concat(data);eqInfo.jma=eqInfo.jma.sort((function(a,b){var r=0;return a.OriginTime>b.OriginTime?r=-1:a.OriginTime<b.OriginTime&&(r=1),r})),mainWindow&&mainWindow.webContents.send("message2",{action:"EQInfo",source:source,data:eqInfo.jma})}else"usgs"==source&&(eqInfo.usgs=eqInfo.usgs.filter(item=>item.eventId!==data.eventId),eqInfo.usgs=eqInfo.usgs.concat(data),mainWindow&&mainWindow.webContents.send("message2",{action:"EQInfo",source:source,data:eqInfo.usgs}))}function TsunamiInfoControl(data){var newInfo=tsunamiData.issue.time<data.issue.time,stilANDjma=tsunamiData.issue.time==data.issue.time&&"jmaXML"==data.source&&"P2P"==tsunamiData.source;(!tsunamiData||newInfo||stilANDjma)&&(tsunamiData=data,newInfo&&createWindow(),mainWindow&&mainWindow.webContents.send("message2",{action:"tsunamiUpdate",data:data,new:newInfo}),tsunamiWindow&&tsunamiWindow.webContents.send("message2",{action:"tsunamiUpdate",data:data,new:newInfo}))}var Ymoni=2e4,Kmoni=2e4,Lmoni=2e4,TestStartTime,monitorVendor="YE";function NetworkError(error,type){Window_notification(type+"との通信でエラーが発生しました。","エラーコードは以下の通りです。\n"+String(error),"error")}var notifications=[],notification_id=0,P2P_ConnectData;function Window_notification(title,detail,type){notifications.push({id:notification_id,type:type,title:title,detail:detail,time:new Date}),notification_id++,mainWindow&&mainWindow.webContents.send("message2",{action:"notification_Update",data:notifications})}async function kmoniServerSelect(){var minTime;await new Promise(resolve=>{var request,request;(YmoniE=1/0,YmoniW=1/0,Kmoni=1/0,Lmoni=1/0,TestStartTime=new Date,net.online)&&((request=net.request("https://weather-kyoshin.east.edge.storage-yahoo.jp/RealTimeData/"+dateEncode(2,new Date-yoyuY-Replay)+"/"+dateEncode(1,new Date-yoyuY-Replay)+".json")).on("response",res=>{300<=res._responseHead.statusCode||res._responseHead.statusCode<200?YmoniE=1e7:(YmoniE=new Date-TestStartTime,YmoniE+YmoniW<1/0&&resolve())}),request.on("error",error=>{NetworkError(error,"Yahoo強震モニタ(East)")}),request.end());net.online&&((request=net.request("https://weather-kyoshin.west.edge.storage-yahoo.jp/RealTimeData/"+dateEncode(2,new Date-yoyuY-Replay)+"/"+dateEncode(1,new Date-yoyuY-Replay)+".json")).on("response",res=>{300<=res._responseHead.statusCode||res._responseHead.statusCode<200?YmoniW=1e7:(YmoniW=new Date-TestStartTime,YmoniE+YmoniW<1/0&&resolve())}),request.on("error",error=>{NetworkError(error,"Yahoo強震モニタ(West)")}),request.end())}),await(minTime=Math.min(YmoniE,YmoniW,Kmoni,Lmoni),minTime==1/0||minTime==YmoniE?monitorVendor="YE":minTime!=1/0&&minTime!=YmoniW||(monitorVendor="YW"),console.log({"YE(Yahoo強震モニタEast)":YmoniE,"YE(Yahoo強震モニタWest)":YmoniW,"K(強震モニタ)":yoyuK,"L(長周期地震動モニタ)":yoyuL}),void console.log("選択結果："+monitorVendor))}async function yoyuSetY(){var yoyuRes;await void(yoyuRes=yoyuSetYCore(500)),yoyuRes&&(await void(yoyuY-=500),await yoyuSetYCore(50)),yoyuY+=Yoyu}async function yoyuSetYCore(delay){yoyuYOK=!1;for(var loopCount=0;!yoyuYOK;)if(loopCount++,await new Promise(resolve=>{try{if(net.online){var request=net.request("https://weather-kyoshin.west.edge.storage-yahoo.jp/RealTimeData/"+dateEncode(2,new Date-yoyuY-Replay)+"/"+dateEncode(1,new Date-yoyuY-Replay)+".json");request.on("response",res=>{300<=res._responseHead.statusCode||res._responseHead.statusCode<200?(yoyuY+=delay,setTimeout(resolve,10)):(yoyuYOK=!0,setTimeout(resolve,10))}),request.on("error",error=>{NetworkError(error,"Yahoo強震モニタ(West)")}),request.end()}}catch(err){}}),loopCount>10){yoyuY=2500;break}return!0}async function yoyuSetK(func){for(var yoyuKOK=!1,loopCount=0,reqTimeTmp;!yoyuKOK;){if(await new Promise(resolve=>{try{if(net.online){var reqTime=new Date,request=net.request("http://www.kmoni.bosai.go.jp/webservice/server/pros/latest.json?_="+Number(new Date));request.on("response",res=>{res.on("end",(function(){reqTimeTmp!==reqTime&&0<loopCount&&(yoyuKOK=!0,yoyuK=new Date-reqTime+Yoyu),reqTimeTmp=new Date(reqTime)})),setTimeout(resolve,10)}),request.on("error",error=>{NetworkError(error,"強震モニタ")}),request.end()}}catch(err){}}),loopCount>25){yoyuK=2500+Yoyu;break}loopCount++}return func(),!0}async function yoyuSetL(func){for(var yoyuLOK=!1,loopCount2=0,reqTimeTmp2;!yoyuLOK;){if(await new Promise(resolve=>{try{if(net.online){var reqTime2=new Date,request=net.request("https://smi.lmoniexp.bosai.go.jp/webservice/server/pros/latest.json?_"+Number(new Date));request.on("response",res=>{res.on("end",(function(){reqTimeTmp2!==reqTime2&&0<loopCount2&&(yoyuLOK=!0,yoyuL=new Date-reqTime2+Yoyu),reqTimeTmp2=new Date(reqTime2)})),setTimeout(resolve,10)}),request.on("error",error=>{NetworkError(error,"長周期地震動モニタ")}),request.end()}}catch(err){}}),loopCount2>25){yoyuL=2500+Yoyu;break}loopCount2++}return func(),!0}function Boolean2(str){switch(str){case"true":return!0;case"false":return!1}}function kmoniTimeUpdate(Updatetime,type,condition,vendor){mainWindow&&mainWindow.webContents.send("message2",{action:"kmoniTimeUpdate",Updatetime:Updatetime,LocalTime:new Date,vendor:vendor,type:type,condition:condition}),"P2P_EEW"==type&&(P2P_ConnectData=[Updatetime,type,condition,vendor]),kmoniTimeTmpElm=kmoniTimeTmp.find((function(elm){return elm.type==type})),kmoniTimeTmpElm?kmoniTimeTmpElm={type:type,Updatetime:Updatetime,LocalTime:new Date}:kmoniTimeTmp.push({type:type,Updatetime:Updatetime,LocalTime:new Date})}function replay(ReplayDate){ReplayDate?(Replay=new Date-new Date(ReplayDate),mainWindow.webContents.send("message2",{action:"Replay",data:Replay})):Replay=0}function dateEncode(type,dateTmp){var YYYY,MM,DD,hh,mm,ss,YYYY,MM,DD,YYYY,MM,DD,hh,mm,ss;if(dateTmp=new Date(dateTmp),1==type)return(YYYY=String(dateTmp.getFullYear()))+(MM=String(dateTmp.getMonth()+1).padStart(2,"0"))+(DD=String(dateTmp.getDate()).padStart(2,"0"))+(hh=String(dateTmp.getHours()).padStart(2,"0"))+(mm=String(dateTmp.getMinutes()).padStart(2,"0"))+(ss=String(dateTmp.getSeconds()).padStart(2,"0"));if(2==type)return(YYYY=String(dateTmp.getFullYear()))+(MM=String(dateTmp.getMonth()+1).padStart(2,"0"))+(DD=String(dateTmp.getDate()).padStart(2,"0"));if(3==type)return(YYYY=String(dateTmp.getFullYear()))+"/"+(MM=String(dateTmp.getMonth()+1).padStart(2,"0"))+"/"+(DD=String(dateTmp.getDate()).padStart(2,"0"))+" "+(hh=String(dateTmp.getHours()).padStart(2,"0"))+":"+(mm=String(dateTmp.getMinutes()).padStart(2,"0"))+":"+(ss=String(dateTmp.getSeconds()).padStart(2,"0"));var YYYY=String(dateTmp.getFullYear()),MM=String(dateTmp.getMonth()+1).padStart(2,"0"),DD=String(dateTmp.getDate()).padStart(2,"0"),hh=String(dateTmp.getHours()).padStart(2,"0"),mm=String(dateTmp.getMinutes()).padStart(2,"0"),ss=String(dateTmp.getSeconds()).padStart(2,"0");return type.replaceAll("YYYY",YYYY),type.replaceAll("MM",MM),type.replaceAll("DD",DD),type.replaceAll("hh",hh),type.replaceAll("mm",mm),type.replaceAll("ss",ss),type}function jsonParse(str){var json;str=String(str);try{json=JSON.parse(str)}catch(error){json=null}return json}function shindoConvert(str,responseType){var ShindoTmp;if(str)if(isNaN(str))switch(str=(str=(str=(str=String(str)).replace(/[０-９]/g,(function(s){return String.fromCharCode(s.charCodeAt(0)-65248)}))).replaceAll("＋","+").replaceAll("－","-").replaceAll("強","+").replaceAll("弱","-")).replace(/\s+/g,"")){case"-1":ShindoTmp="?";break;case"1":case"10":ShindoTmp="1";break;case"2":case"20":ShindoTmp="2";break;case"3":case"30":ShindoTmp="3";break;case"4":case"40":ShindoTmp="4";break;case"5-":case"45":ShindoTmp="5-";break;case"5+":case"50":ShindoTmp="5+";break;case"6-":case"55":ShindoTmp="6-";break;case"6+":case"60":ShindoTmp="6+";break;case"7":case"70":ShindoTmp="7";break;case"99":ShindoTmp="7+"}else ShindoTmp=str<.5?"0":str<1.5?"1":str<2.5?"2":str<3.5?"3":str<4.5?"4":str<5?"5-":str<5.5?"5+":str<6?"6-":str<6.5?"6+":6.5<=str?"7":7.5<=str?"7+":"?";else ShindoTmp="?";if(!["?","0","1","2","3","4","5-","5+","6-","6+","7","7+"].includes(ShindoTmp))return str;switch(responseType){case 1:var ConvTable;return(ConvTable={"?":"不明",0:"0",1:"1",2:"2",3:"3",4:"4","5-":"5弱","5+":"5強","6-":"6弱","6+":"6強",7:"7","7+":"7以上"})[ShindoTmp];case 2:var ConvTable;return(ConvTable={"?":["#D1D1D1","#444"],0:["#D1D1D1","#444"],1:["#54C9E3","#222"],2:["#2B8DFC","#111"],3:["#32BA37","#111"],4:["#DBD21F","#000"],"5-":["#FF8C00","#FFF"],"5+":["#FF5714","#FFF"],"6-":["#E60000","#FFF"],"6+":["#8A0A0A","#FFF"],7:["#C400DE","#FFF"],"7+":["#C400DE","#FFF"]})[ShindoTmp];case 0:default:return ShindoTmp}}function latitudeConvert(data){return isNaN(data)?data.match(/N/)?Number(data.replace("N","")):data.match(/S/)?0-Number(data.replace("S","")):data.match(/E/)?Number(data.replace("E","")):data.match(/W/)?0-Number(data.replace("W","")):data:Number(data)}function geosailing(a,b,c,d){with(Math)return 6371.008*acos(sin(a*(i=PI/180))*sin(c*i)+cos(a*i)*cos(c*i)*cos(b*i-d*i))}